<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>NeurVision:MRI Based Tumor Analysis</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='detection.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="icon" href="{{ url_for('static', filename='fav.jpg') }}" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <i class="fa-solid fa-brain"></i>
      </div>
      <div class="header-text">
        <h1>NeuroVision:MRI-Based Tumor Analysis</h1>
      </div>
      <nav class="nav-links">
        <a href="{{ url_for('home') }}">Home</a>
        <a href="{{ url_for('detection') }}">Detection</a>
        <a href="{{ url_for('logout') }}" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </nav>
    </header>

    <!-- Main Section -->
    <section class="container">
      <!-- Input Card -->
      <div class="card">
        <div class="card-title">
          <i class="fa-solid fa-upload"></i>
          <h2>Input Section</h2>
        </div>

        <div class="upload-box" id="uploadBox">
          <i class="fa-solid fa-cloud-arrow-up"></i>
          <p class="upload-text">
            <span>Click to upload</span> or drag and drop
          </p>
          <p class="formats">Accepted formats: JPG, PNG</p>
          <input type="file" id="imageInput" accept=".jpg,.jpeg,.png" />
          <img id="previewImage" class="preview-image" alt="Preview" />
        </div>

        <button class="analyze-btn" id="analyzeBtn">
          <i class="fas fa-magnifying-glass"></i> Analyze MRI Scan
        </button>
      </div>

      <!-- Output Card -->
      <div class="card">
        <div class="card-title">
          <i class="fa-solid fa-wave-square"></i>
          <h2>Output Section</h2>
        </div>

        <div class="output-box" id="outputBox">
          <div class="result-content" id="resultContent">
            <i class="fa-solid fa-brain"></i>
            <h3>No analysis yet</h3>
            <p>Upload an MRI scan to begin</p>
          </div>
        </div>

        <!-- History Section -->
        <div class="history-section">
          <h3><i class="fas fa-history"></i> Recent Analyses</h3>
          <ul class="history-list" id="historyList">
            <!-- History items will be added here -->
          </ul>
        </div>
      </div>
    </section>

    <!-- Grad-CAM Modal -->
    <div id="gradcamModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2><i class="fas fa-fire"></i> Grad-CAM Heatmap Visualization</h2>
        <div class="gradcam-container">
          <div class="gradcam-image-wrapper">
            <h3>Original MRI</h3>
            <img id="originalImage" alt="Original" />
          </div>
          <div class="gradcam-image-wrapper">
            <h3>Tumor Localization Heatmap</h3>
            <img id="gradcamImage" alt="Grad-CAM" />
          </div>
        </div>
        <div class="gradcam-legend">
          <p><strong>Color Guide:</strong></p>
          <div class="legend-bar"></div>
          <div class="legend-labels">
            <span>Low Activation</span>
            <span>High Activation (Tumor Region)</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      // DOM Elements
      const uploadBox = document.getElementById("uploadBox");
      const imageInput = document.getElementById("imageInput");
      const previewImage = document.getElementById("previewImage");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const outputBox = document.getElementById("outputBox");
      const resultContent = document.getElementById("resultContent");
      const historyList = document.getElementById("historyList");
      const modal = document.getElementById("gradcamModal");
      const closeModal = document.getElementsByClassName("close")[0];
      const originalImage = document.getElementById("originalImage");
      const gradcamImage = document.getElementById("gradcamImage");

      let currentGradcamData = null;

      // Preview uploaded image
      imageInput.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            previewImage.src = e.target.result;
            previewImage.style.display = "block";
            uploadBox.querySelector(".fa-cloud-arrow-up").style.display =
              "none";
            uploadBox.querySelector(".upload-text").style.display = "none";
            uploadBox.querySelector(".formats").style.display = "none";
          };
          reader.readAsDataURL(file);
        }
      });

      // Modal controls
      closeModal.onclick = function () {
        modal.style.display = "none";
      };

      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      function showGradcam() {
        if (currentGradcamData) {
          originalImage.src = previewImage.src;
          gradcamImage.src = currentGradcamData;
          modal.style.display = "block";
        }
      }

      // Send image to backend
      analyzeBtn.addEventListener("click", detectTumor);

      function detectTumor() {
        if (!imageInput.files.length) {
          alert("‚ö†Ô∏è Please upload an MRI image first.");
          return;
        }

        const file = imageInput.files[0];
        const reader = new FileReader();

        reader.onload = () => {
          const base64String = reader.result;
          const payload = { image: [base64String] };

          resultContent.innerHTML = `
            <i class="fas fa-spinner fa-spin" style="font-size: 50px;"></i>
            <h3>Analyzing MRI Scan...</h3>
            <p>Please wait while we process your image</p>
          `;
          outputBox.style.background = "#f8fbff";

          fetch("/predict", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((res) => res.json())
            .then((data) => {
              console.log("üì• Received data:", data);

              if (data.error) {
                resultContent.innerHTML = `
                  <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 50px;"></i>
                  <h3>Error</h3>
                  <p>${data.error}</p>
                `;
                return;
              }

              const prediction = data.predictions[0];
              console.log("üîç Prediction:", prediction);
              console.log("üî• Grad-CAM data exists:", !!prediction.gradcam);
              console.log("üî• Grad-CAM data type:", typeof prediction.gradcam);

              const highestConfidence = parseFloat(
                prediction.highest_confidence,
              );
              currentGradcamData = prediction.gradcam;

              if (prediction.tumor_type === "No Tumor") {
                outputBox.style.background = "#d1fae5";
              } else {
                outputBox.style.background = "#fee2e2";
              }

              if (highestConfidence >= 50) {
                resultContent.innerHTML = `
                  <div class="result-header ${prediction.tumor_type === "No Tumor" ? "no-tumor" : "tumor-detected"}">
                    <i class="fas ${prediction.tumor_type === "No Tumor" ? "fa-check-circle" : "fa-exclamation-triangle"}"></i>
                    <h2>${prediction.tumor_type.toUpperCase()}</h2>
                    <div class="confidence-badge">
                      Confidence: ${prediction.highest_confidence}
                    </div>
                  </div>
                  <div class="result-message">
                    ${
                      prediction.tumor_type === "No Tumor"
                        ? "‚úÖ No tumor detected in the MRI scan."
                        : `‚ö†Ô∏è <strong>${prediction.tumor_type}</strong> detected with high confidence. Please consult a medical professional.`
                    }
                  </div>
                `;

                // Add Grad-CAM button if tumor detected and gradcam available
                if (
                  prediction.gradcam &&
                  prediction.tumor_type !== "No Tumor"
                ) {
                  const gradcamBtn = document.createElement("button");
                  gradcamBtn.className = "gradcam-btn";
                  gradcamBtn.innerHTML =
                    '<i class="fas fa-fire"></i> View Heatmap Visualization';
                  gradcamBtn.onclick = showGradcam;
                  resultContent.appendChild(gradcamBtn);

                  console.log("‚úÖ Grad-CAM button added");
                } else {
                  console.log("‚ö†Ô∏è No Grad-CAM data available");
                }
              } else {
                outputBox.style.background = "#fef3c7";
                resultContent.innerHTML = `
                  <div class="result-header low-confidence">
                    <i class="fas fa-question-circle" style="color: #f59e0b; font-size: 50px;"></i>
                    <h2>INCONCLUSIVE RESULT</h2>
                    <div class="confidence-badge low">
                      Confidence: ${prediction.highest_confidence}
                    </div>
                  </div>
                  <div class="result-message">
                    <p>‚ö†Ô∏è Analysis confidence is below threshold (${prediction.highest_confidence} &lt; 50%).</p>
                    <p>Please upload a clearer MRI image or consult with a medical specialist.</p>
                  </div>
                `;
              }

              const li = document.createElement("li");
              li.innerHTML = `
                <img src="${previewImage.src}" width="50" height="50">
                <div>
                  <strong>${prediction.tumor_type}</strong>
                  <span>${prediction.highest_confidence}</span>
                  <small>${new Date().toLocaleTimeString()}</small>
                </div>
              `;
              historyList.prepend(li);
            })
            .catch((err) => {
              console.error(err);
              resultContent.innerHTML = `
                <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 50px;"></i>
                <h3>Network Error</h3>
                <p>Please check your connection and try again</p>
              `;
            });
        };

        reader.readAsDataURL(file);
      }

      // Drag and drop functionality
      uploadBox.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadBox.style.borderColor = "#1e66ff";
        uploadBox.style.background = "#f0f6ff";
      });

      uploadBox.addEventListener("dragleave", () => {
        uploadBox.style.borderColor = "#9ec5ff";
        uploadBox.style.background = "transparent";
      });

      uploadBox.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadBox.style.borderColor = "#9ec5ff";
        uploadBox.style.background = "transparent";

        if (e.dataTransfer.files.length) {
          imageInput.files = e.dataTransfer.files;
          const event = new Event("change");
          imageInput.dispatchEvent(event);
        }
      });
    </script>
  </body>
</html>
